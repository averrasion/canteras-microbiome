---
title: "Bacterial Indexes"
---

```{r}
#| label: setup
#| include: false

Sys.setlocale("LC_TIME", "en_US.utf8")

library(tidyverse)
library(ggridges)
library(here)

source(here("_common.R"))

samples <- 
  read_csv(here("data", "samples.csv"), col_types = cols(location = col_factor(levels = locations))) |>
  mutate(date = make_datetime(year, month, day)) |> 
  mutate(season = make_season(date))

indexes <-
  read_csv(here("data", "prokaryotes.csv")) |> 
  left_join(samples, by = join_by(sample)) |> 
  group_by(sample, location, date, season) |> 
  summarize(
    alpha           = sum(reads[class    == "Alphaproteobacteria"], na.rm = T),
    gamma           = sum(reads[class    == "Gammaproteobacteria"], na.rm = T),
    alteromonas     = sum(reads[genus    == "Alteromonas"],         na.rm = T),
    sar11           = sum(reads[order    == "SAR11 clade"],         na.rm = T),
    oceanospirillum = sum(reads[order    == "Oceanospirillum"],     na.rm = T),
    bacteroidetes   = sum(reads[phylum   == "Bacteroidota"],        na.rm = T),
    nitrospira      = sum(reads[phylum   == "Nitrospirota"],        na.rm = T),
    burkholderiales = sum(reads[order    == "Burkholderiales"],     na.rm = T),
    bacilli         = sum(reads[class    == "Bacilli"],             na.rm = T),
    clostridia      = sum(reads[class    == "Clostridia"],          na.rm = T)
  ) |> 
  mutate(
    index_as   = (alteromonas) / sar11,
    index_aos  = (alteromonas + oceanospirillum) / sar11,
    index_bngb = (bacteroidetes + nitrospira + gamma) / burkholderiales,
    index_bbca = (bacilli + bacteroidetes + clostridia) / alpha
  ) |> 
  pivot_longer(starts_with("index"), names_to = "index", names_prefix = "index_")
```

| Index | Formula | Reference |
|----------------|:---------------------------------:|----------------------|
| A:S | $\frac{\text{Alteromonas}}{\text{SAR11}}$ | [@ferrera2016] |
| AO:S | $\frac{\text{Alteromonas+Oceanospirillum}}{\text{SAR11}}$ | [@ferrera2016] |
| BNγ:β | $\frac{\text{Bacteroidetes+Nitrospira+γ-Proteobacteria}}{\text{β-Proteobacteria}}$ | [@garrido2014] |
| BBC:α | $\frac{\text{Bacilli+Bacteroidetes+Clostridia}}{\text{α-Proteobacteria}}$ | [@wu2010] |

## What were the ranges of these indexes?

```{r}
indexes |> 
  filter(value > 0) |> 
  ggplot(aes(x = value, y = index)) +
  geom_density_ridges(aes(fill = index), alpha = .5, scale = 3, bandwidth = .2, show.legend = F) +
  scale_x_log10(labels = scales::label_number(), expand = c(0, 0)) +
  scale_y_discrete(labels = labels_index, name = NULL, expand = c(0, 0)) +
  coord_cartesian(clip = "off") +
  labs(x = "Index value") +
  theme_classic()
```

```{r}
#| label: fig-overview-2
#| fig-cap: Median nutrient concentrations with min-max ranges across seasons. Vertical axis in logarithmic scale.
#| warning: false

indexes |> 
  ggplot(aes(x = season, y = value, color = index)) +
  geom_pointrange(stat = "summary", position = position_dodge(width = .6), fun = median, fun.min = min, fun.max = max) +
  scale_x_discrete(labels = labels_season, name = NULL) +
  scale_y_log10() +
  scale_color_discrete(labels = labels_index, name = NULL) +
  labs(y = "Index value") +
  theme_classic() +
  theme(
    legend.position = "inside", legend.position.inside = c(.9, .15), 
    legend.background = element_rect(color = "black")
    )
```
## How did these indexes vary across the monotring?

```{r}
indexes |>
  filter(value > 0) |> 
  filter_analysis() |> 
  ggplot(aes(y = fct_rev(location), x = value)) +
  geom_boxplot(aes(fill = index), show.legend = F) +
  facet_wrap(~ index, scales = "free_x", labeller = as_labeller(labels_index)) +
  scale_x_log10() +
  scale_y_discrete(labels = labels_location) +
  labs(x = "", y = "") +
  theme_classic()
```

```{r}
indexes |>
  filter(value > 0) |> 
  filter_analysis() |> 
  ggplot(aes(x = date, y = value, shape = location, color = location)) +
  geom_jitter(size = 2) +
  facet_wrap(~ index, scales = "free_y", labeller = as_labeller(labels_index)) +
  scale_x_datetime(date_labels = "%b %Y", name = NULL) +
  scale_y_log10() +
  scale_color_discrete(labels = labels_location, name = NULL) +
  scale_shape_discrete(labels = labels_location, name = NULL) +
  labs(y = "Index value") +
  theme_classic() +
  theme(
    legend.position = "inside", legend.position.inside = c(.1, .35), 
    legend.background = element_rect(color = "black")
    )
```


