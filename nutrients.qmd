---
title: "Nutrients"
---

```{r}
#| label: setup
#| include: false

Sys.setlocale("LC_TIME", "en_US.utf8")

library(tidyverse)
library(here)

source(here("_common.R"))

nutrients <- 
  read_csv(
    here("data", "nutrients.csv"),
    col_types = cols(location = col_factor(levels = locations), formula = col_factor())
  ) |> 
  mutate(season = make_season(date))

filter_organic <- function(data){
  data |> filter(formula %in% c("toc", "ton"))
}

filter_inorganic <- function(data){
  data |>
    filter(formula %in% c("silicate", "phosphate", "ammonium", "nitrates_and_nitrites"))
}
```

## Introduction

The environmental availability of certain nutrients on which microbes depend can deeply shape the composition of the microbiome. Chemically speaking, nutrients are very diverse in molecular weight, composition and complexity. In this project we will classify them into two main groups:

 - Organic nutrients: Total organic carbon (TOC), and total organic nitrogen (TON).
 - Inorganic nutrients: silicate [Si(OH)₄], phosphate (PO4³⁻), ammonium (NH₄⁺), and inorganic nitrogen (NO₃⁻ + NO₂⁻).

By observing overall distribution in @fig-nutrients-overview, we can pinpoint an evident difference between organic and inorganic nutrients. That is, organic nutrients concentration ranges are two to three orders of magnitude higher, with TOC close to 100 μM, and TON around 10 μM. This proportion is representative of the Redfield ratio [@redfield1933], which quantifies elemental concentrations of marine organic matter according to the proportion $C:N:P = 106:16:1$. This proportion is highly representative of our data.
From a statistical perspective, distributions with two clear heaps ---known as *bimodal distributions*--- like those of TON and PO4³⁻ likely represent clearly identifiable environmental states based on nutrient availability. It can be hypothesized that anthropogenic input of nutrient could be a driving factor of such processes.

```{r}
#| label: fig-nutrients-overview
#| fig-cap: Distribution density functions for all nutrient chemical formulas measured. Horizontal axis in logarithmic scale.

nutrients |> 
  filter(conc > 0) |> 
  ggplot(aes(x = conc, fill = formula)) +
  geom_density(color = "black", alpha = .5) +
  scale_fill_discrete(labels = labels_formula) +
  scale_x_log10(labels = scales::label_number()) +
  labs(x = "concentration (μM)", fill = "", color = "") +
  theme_classic() +
  theme(legend.position = "inside", legend.position.inside = c(.15, .7))
```

## Organic nutrients distribution

```{r}
#| label: fig-nutrients-organic-spatial
#| fig-cap: Box plots of organic nutrient spatial distribution across all measuring stations. Horizontal axis in logarithmic scale.

nutrients |>
  filter(conc > 0) |> 
  filter_organic() |> 
  ggplot(aes(y = fct_rev(location), x = conc)) +
  geom_boxplot(outliers = F) +
  geom_jitter(alpha = .3, width = .3) +
  facet_wrap(~ formula, scales = "free_x", labeller = as_labeller(labels_formula)) +
  scale_y_discrete(labels = labels_location) +
  scale_x_log10() +
  labs(x = "concentration (μM)", y = "") +
  theme_classic()
```

```{r}
#| label: fig-nutrients-organic-temporal
#| fig-cap: Organic nutrient temporal distribution. Vertical axis in logarithmic scale.

nutrients |> 
  filter_organic() |> 
  filter_analysis() |> 
  ggplot(aes(x = date, conc, shape = location, color = location)) +
  geom_jitter(size = 2) +
  facet_wrap(
    ~ formula, nrow = 2, scale = "free_y", labeller = as_labeller(labels_formula)
  ) +
  scale_shape_discrete(labels = labels_location) +
  scale_color_discrete(labels = labels_location) +
  scale_y_log10() +
  scale_x_datetime(breaks = seasons_limits, date_labels = "%b %Y") +
  labs(y = "concentration (μM)", shape = "", color = "") +
  theme_bw() +
  theme(axis.title.x = element_blank(), legend.position = "bottom")
```


```{r}
#| label: fig-nutrients-organic-seasonal
#| fig-cap: Box plots of organic nutrient seasonal distribution. Vertical axis in logarithmic scale.

nutrients |> 
  filter_organic() |> 
  filter_analysis() |> 
  ggplot(aes(x = season, conc)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ formula, scale = "free_y", labeller = as_labeller(labels_formula)) +
  geom_jitter(alpha = .3, width = .3) +
  scale_x_discrete(labels = labels_season) +
  scale_y_log10() +
  labs(x = "", y = "concentration (μM)") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 20, vjust = .5))
```

```{r}
#| label: fig-nutrients-organic-detailed
#| fig-cap: Detailed box plots of organic nutrient distribution. Vertical axis in logarithmic scale.

nutrients |> 
  filter(conc > 0) |> 
  filter_organic() |> 
  filter_analysis() |> 
  ggplot(aes(x = season, y = conc, fill = location, color = location)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ formula, scale = "free_y", labeller = as_labeller(labels_formula)) +
  scale_x_discrete(labels = labels_season) +
  scale_color_discrete(labels = labels_location) +
  scale_fill_discrete(labels = labels_location) +
  scale_y_log10() +
  labs(x = "", y = "concentration (μM)", fill = "", color = "") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 20, vjust = .5))
```

## Inorganic nutrients distribution

```{r}
#| label: fig-nutrients-inorganic-spatial
#| fig-cap: Box plots of inorganic nutrient spatial distribution across all measuring stations. Horizontal axis in logarithmic scale.

nutrients |>
  filter(conc > 0) |> 
  filter_inorganic() |> 
  ggplot(aes(y = fct_rev(location), x = conc)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ formula, scales = "free_x", labeller = as_labeller(labels_formula)) +
  scale_y_discrete(labels = labels_location) +
  scale_x_log10() +
  labs(x = "concentration (μM)", y = "") +
  theme_classic()
```

```{r}
#| label: fig-nutrients-inorganic-temporal
#| fig-cap: Inorganic nutrient temporal distribution. Vertical axis in logarithmic scale.

nutrients |> 
  filter(conc > 0) |> 
  filter_inorganic() |> 
  filter_analysis() |> 
  ggplot(aes(x = date, conc, shape = location, color = location)) +
  geom_jitter(size = 2) +
  facet_wrap(
    ~ formula, nrow = 2, scale = "free_y", labeller = as_labeller(labels_formula)
  ) +
  scale_shape_discrete(labels = labels_location) +
  scale_color_discrete(labels = labels_location) +
  scale_x_datetime(breaks = seasons_limits, date_labels = "%b %Y") +
  scale_y_log10() +
  labs(x = "", y = "concentration (μM)", shape = "", color = "") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 20, vjust = .5))
```

```{r}
#| label: fig-nutrients-inorganic-seasonal
#| fig-cap: Box plots of inorganic nutrient seasonal distribution across all measuring stations. Vertical axis in logarithmic scale.

nutrients |> 
  filter(conc > 0) |> 
  filter_inorganic() |> 
  filter_analysis() |> 
  ggplot(aes(x = season, y = conc)) +
  geom_boxplot(outliers = F) +
  facet_wrap(
    ~ formula, nrow = 2, scale = "free_y", labeller = as_labeller(labels_formula)
  ) +
  geom_jitter(alpha = .3, width = .3) +
  scale_x_discrete(labels = labels_season) +
  scale_y_log10() +
  labs(x = "", y = "concentration (μM)") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 20, vjust = .5))
```

```{r}
#| label: fig-nutrients-inorganic-detailed
#| fig-cap: Detailed box plots of inorganic nutrient distribution. Vertical axis in logarithmic scale.

nutrients |> 
  filter(conc > 0) |> 
  filter_inorganic() |> 
  filter_analysis() |> 
  ggplot(aes(x = season, y = conc, fill = location, color = location)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ formula, scales = "free_y", labeller = as_labeller(labels_formula)) +
  scale_x_discrete(labels = labels_season) +
  scale_color_discrete(labels = labels_location) +
  scale_fill_discrete(labels = labels_location) +
  scale_y_log10() +
  labs(x = "", y = "concentration (μM)", fill = "", color = "") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 20, vjust = .5))
```
## Eutrophization

Locations in Las Canteras beach appear to have overall higher inorganic nutrient concentrations (@fig-nutrients-inorganic-spatial). Hotel Cristina is characterized by relative higher overall nutrient concentrations. An increasing tendency is observed starting in autumn 2022 reaching it maximum in the spring 2023--when our data ends, so it likely increases beyond. This process is unprecedented in the project's scope, we can vaguely interpret it as inputs from the city's sewage system, however further investigation outside this project's scope should be conducted. Visit [Bacterial Indexes](bacterial-indexes.qmd) to explore the response of the bacterial community to these changes.

